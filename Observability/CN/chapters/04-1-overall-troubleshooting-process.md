# 4.1 故障排查整体流程

## 4.1.1 从客户端到服务端的请求路径

1. **DNS 解析**
2. **TCP 连接建立**
3. **TLS 握手（如适用）**
4. **请求发送与响应接收**

## 4.1.2 分层排查思路

- **应用层**
- **服务层**
- **网络层**
- **物理层**

---

## 排查应用系统故障的详细步骤

应用系统故障排查需要从应用层到网络层系统性地进行分析。以下是结合应用指标、网络指标和日志分类的详细排查流程：

### 1. 明确故障现象和范围

#### 1.1 收集用户反馈

- **用户报告的现象**：页面无法加载、服务超时、功能异常等。
- **报错信息**：前端或客户端显示的具体错误提示（如 HTTP 404、500 等）。

#### 1.2 划定故障范围

- **全局问题**：所有用户都受到影响，例如服务完全不可用。
- **局部问题**：仅部分用户或功能受到影响，例如特定接口报错。

### 2. 从应用层开始排查

#### 2.1 查看应用日志

**目标**：确定是否有内部错误（服务端异常）或客户端发送无效请求。

**步骤**：

- **检查服务端异常**：
  - 查看应用日志是否有错误堆栈（如 NullPointerException、SQL 错误）。
  - 排查 HTTP 500 或其他 5xx 错误相关的记录。
  - **示例**：

    ```
    ERROR: Database connection failed for query: SELECT * FROM users WHERE id=123
    ```

- **检查客户端异常**：
  - 查看是否有 HTTP 400 错误（如请求格式错误）。
  - **示例**：

    ```
    WARN: Invalid input received: missing field 'username'
    ```

#### 2.2 分析应用指标

- **响应时间**：是否显著增加，指向可能的性能问题。
- **错误率**：是否有明显的增长趋势。
- **系统资源使用率**：CPU、内存是否耗尽。

**排查要点**：

- 如果响应时间高：进一步分析是服务内部处理耗时，还是调用外部依赖（如数据库、第三方服务）导致。
- 如果错误率高：根据日志，确认是否是特定接口或全局问题。

#### 2.3 验证依赖服务

- **数据库、缓存系统、消息队列等外部依赖是否正常**：

  - **数据库问题**：
    - 超时、连接池耗尽。
    - SQL 查询慢导致请求超时。
  - **缓存问题**：
    - 缓存未命中，导致频繁访问数据库。
    - Redis/Memcached 服务不可用。
  - **第三方服务问题**：
    - 调用第三方 API 超时或返回错误。

### 3. 从服务层排查

#### 3.1 调用日志分析

**目标**：检查服务间调用是否正常，定位异常的服务节点。

**步骤**：

- **服务间调用异常**：
  - 查看调用日志是否有 HTTP 503、502 等状态码。
  - **示例**：

    ```
    2024-11-22 10:00:01 GET /api/orders/12345 Status: 503
    ```

- **调用性能问题**：
  - 检查调用链的延迟指标（Tracing 数据）。
  - 是否某个服务的响应时间显著增加。

#### 3.2 服务依赖健康检查

**目标**：确认服务的健康状况。

**步骤**：

- 检查服务是否在注册中心（如 Consul、Etcd）中处于健康状态。
- 使用 `curl` 或 `ping` 测试服务接口的可用性。

### 4. 从网络层排查

#### 4.1 查看流日志

**目标**：排查网络连接问题，确认流量是否正常到达。

**步骤**：

- 查看流日志是否有异常的流量模式：
  - 连接失败（如大量 RST 包）。
  - 丢包率是否过高。
  - **示例**：

    ```
    SrcIP: 192.168.1.10 DstIP: 10.0.0.5 Protocol: TCP Flags: RST
    ```

#### 4.2 分析网络指标

- **延迟**：检查 RTT 是否显著增加。
- **丢包率**：高丢包可能导致服务不可用或超时。
- **重传率**：高重传可能是网络拥塞或链路质量差的信号。

#### 4.3 网络层问题验证

**目标**：判断是否为网络问题导致的故障。

**步骤**：

- 使用 `ping` 或 `traceroute` 确认网络延迟和链路状态。
- 使用工具 `tcpdump` 或 Wireshark 捕获数据包，分析是否有丢包、RST 等异常。

### 5. 综合分析日志和指标

#### 5.1 应用日志

- 定位代码错误或业务逻辑问题。
- **示例**：

ERROR: User authentication failed due to missing token.

markdown
复制代码

#### 5.2 服务日志

- 追踪服务调用链，确认异常服务或节点。
- **示例**：

Service A -> Service B [Timeout]


#### 5.3 网络日志

- 分析流量和连接状态，确认网络稳定性。
- **示例**：

TCP Retransmissions detected: 10% packets lost.


### 6. 常见故障场景及排查思路

| **故障现象**     | **可能原因**                         | **排查方法**                                               |
|------------------|--------------------------------------|------------------------------------------------------------|
| 页面加载缓慢     | 服务响应时间长、数据库查询慢、网络延迟高 | 检查响应时间指标，分析慢查询日志，验证网络延迟和丢包。         |
| HTTP 500 错误    | 服务端代码错误、资源耗尽、依赖服务不可用   | 查看应用日志中的异常堆栈，检查系统资源使用率，验证外部依赖服务状态。 |
| HTTP 503 错误    | 服务过载或正在维护                     | 检查系统资源使用情况，查看调用日志是否有过载信息，确认流量是否超出服务能力。 |
| HTTP 404 错误    | 请求资源不存在                        | 查看客户端请求路径是否正确，分析应用日志是否有未处理的资源。     |
| 无法连接服务     | 网络中断、DNS 解析失败、服务未启动         | 检查网络流日志，测试目标服务连接状态，验证 DNS 解析。        |
| 请求被中断或取消 | 客户端刷新、网络不稳定                   | 查看客户端错误日志，分析网络连接稳定性。                     |

### 7. 整体流程总结

1. **确认现象**：收集用户反馈，划定问题范围。
2. **应用层分析**：查看应用日志，确认是否存在服务端或客户端错误。
3. **服务层分析**：检查服务调用链，验证依赖服务健康状态。
4. **网络层分析**：通过流日志和网络指标，排查连接和链路问题。
5. **综合定位**：结合日志、指标和用户反馈，确认根因并制定修复方案。

通过系统性的排查方法，可以快速定位故障的来源并采取对应的解决措施。
